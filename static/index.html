<!DOCTYPE html>
<html lang="en" style="height: 100%">
<head>
  <meta name="viewport" content="width=device-width" initial-scale="1"/>
  <meta charset="UTF-8">
  <title>扑克牌</title>
</head>
<body style="height: 100%; margin: 0; background: aliceblue">
<style>
.message {-webkit-box-sizing: border-box;box-sizing: border-box;margin: 0;padding: 0;color: rgba(0,0,0,.85);font-size: 14px;font-variant: tabular-nums;line-height: 1.5715;list-style: none;-webkit-font-feature-settings: "tnum";font-feature-settings: "tnum";position: fixed;top: 8px;left: 0;z-index: 1010;width: 100%;pointer-events: none;text-align: center;}
.message > div {padding: 6px;}
.message > div > div {display: inline-block;padding: 12px 18px;background: #fff;border-radius: 2px;-webkit-box-shadow: 0 3px 6px -4px rgba(0,0,0,.12), 0 6px 16px 0 rgba(0,0,0,.08), 0 9px 28px 8px rgba(0,0,0,.05);box-shadow: 0 3px 6px -4px rgba(0,0,0,.12), 0 6px 16px 0 rgba(0,0,0,.08), 0 9px 28px 8px rgba(0,0,0,.05);pointer-events: all;}
</style>
<div id="message" class="message"></div>

<div style="position: fixed; top: 0; left: 0;">
  <button id="offline" onclick="game.online ? setOffline() : changeRoom(window.prompt('请输入房间号，开启联机对战。第一进入房间者执黑，第二进入房间者执白，其他人可观战。'))">转为离线模式</button>
</div>
<script>
  const messageDiv = document.getElementById('message');
  const Message = (content) => {
    const div = document.createElement('div');
    div.innerHTML = `<div>${content}</div>`;
    messageDiv.appendChild(div);
    setTimeout(() => messageDiv.removeChild(div), 3000);
  };
  (() => {
    const userIdCookieKey = 'client_id';
    const userIdLocalStorageKey = 'user.id';
    const createUserId = () => Math.random().toFixed(6).substr(2) + new Date().getTime().toString().substr(0, 10);
    const getUserIdCookie = () => {
      const result = new RegExp('(?:;| |^)' + userIdCookieKey + '=([^;]*)').exec(document.cookie);
      if (!result || result.length < 2) return null;
      return decodeURIComponent(result[1]);
    };
    const setUserIdCookie = (userId) => {
      const d = new Date();
      d.setFullYear(d.getFullYear() + 5);
      document.cookie = userIdCookieKey + '=' + userId + ';domain=.hullqin.cn;expires=' + d.toUTCString();
    };
    const getUserIdLocalStorage = () => {
      return window.localStorage.getItem(userIdLocalStorageKey);
    };
    const setUserIdLocalStorage = (userId) => {
      window.localStorage.setItem(userIdLocalStorageKey, userId);
    }
    const getUserId = () => {
      const cookieUserId = getUserIdCookie();
      const localStorageUserId = getUserIdLocalStorage();
      if (!cookieUserId) {
        if (!localStorageUserId) {
          const userId = createUserId();
          setUserIdLocalStorage(userId);
          setUserIdCookie(userId);
          return userId;
        } else {
          setUserIdCookie(localStorageUserId);
          return localStorageUserId;
        }
      } else {
        if (cookieUserId !== localStorageUserId) {
          setUserIdLocalStorage(cookieUserId);
        }
        return cookieUserId;
      }
    };
    window.currentUserId = getUserId();
  })();
  const game = {};
  let ws = null;
  const initializeGame = (room) => {
    game.room = room;
    if (game.room) {
      document.getElementById('offline').innerText = '转为离线模式';
      ws = new WebSocket(`ws://${window.location.host}`);
      ws.onopen = () => {
        ws.send(JSON.stringify({type: 'user.init', user_id: window.currentUserId, room_id: game.room}));
      };
      ws.onerror = (_ => {
        console.error('error');
      });
      ws.onclose = (event => {
        if (event.code !== 1000) {
          if (event.code === 3200) {
            alert('您已在新的浏览器窗口中进入了该房间，本页面连接中断！');
          } else {
            alert('网络问题，连接已断开！请刷新页面！');
          }
        }
      });
      ws.onmessage = (ev => {
        const data = JSON.parse(ev.data);
        console.log(data);
        const { type } = data;
        if (type === 'room.init') {
        }
      });
    } else {
      document.getElementById('offline').innerText = '开始联机对战';
      if (ws) {
        ws.close();
        ws = null;
      }
    }
  };
  initializeGame(window.location.pathname.substr(1));
  window.onpopstate = (event) => {
    initializeGame(event.target.location.pathname.substr(1));
  };
  const setOffline = () => {
    window.history.pushState({preserve: true}, null, '/');
    initializeGame('', true);
    Message('切换至离线模式，可自由模拟棋局，按浏览器返回键可回到房间。')
  };
  const changeRoom = (room) => {
    room = room.replace(/ /g, '');
    if (!room) {
      alert('请输入房间号，空格会被忽略，房间号不能为空');
    } else {
      window.history.pushState(null, null, `/${room}`);
      initializeGame(room);
    }
  };
</script>
</body>
</html>